<% layout("./layouts/boilerplate")-%>
<link rel="stylesheet" href="/css/no-results.css" />
<body>
  <div class="d-flex mb-3 align-items-center justify-content-center">
    <div class="category-scroll d-flex overflow-auto mt-1 px-3 py-2 gap-4">
      <% categoryList.forEach(cat => { %>
      <button
        class="btn d-flex flex-column align-items-center category-btn underline-slide border-0 px-2"
        data-category="<%= cat %>"
      >
        <i
          class="fa-solid fa-<%= categoryIcons[cat] || 'tag' %> fs-8 mb-1 text-black"
        ></i>
        <span class="small"><%= cat %></span>
      </button>
      <% }) %>
    </div>
    <div
      class="form-check form-switch form-check-reverse d-none d-lg-flex align-items-center justify-content-center ms-2 gap-2 taxSwitch"
    >
      <label class="form-check-label" for="taxToggle">Include Tax</label>
      <input
        class="form-check-input"
        type="checkbox"
        role="switch"
        id="taxToggle"
      />
    </div>
  </div>

  <div
    id="listings-container"
    class="row row-cols-lg-4 row-cols-md-2 row-cols-sm-1 g-4"
  >
    <% if (allListings.length === 0) { %>
    <!-- No results - break out of grid -->
    </div>
    <div
      class="container-fluid d-flex justify-content-center align-items-center"
      style="min-height: 60vh"
    >
      <div class="no-results-container">
        <div class="no-results-illustration">
          <div class="search-icon-art">
            <i class="bi bi-search"></i>
            <div class="search-decorative">
              <div class="search-circle"></div>
              <div class="search-circle"></div>
              <div class="search-circle"></div>
            </div>
          </div>
          <div class="search-dots">
            <div class="search-dot"></div>
            <div class="search-dot"></div>
            <div class="search-dot"></div>
          </div>
        </div>

        <div class="no-results-text">
          <h2>No stays found!</h2>
          <p>
            We couldn't find any properties matching your search. Try adjusting
            your filters or search for different keywords.
          </p>
        </div>
      </div>
    </div>
    <% } else { %>
    <% for (let i = 0; i < allListings.length; i++) { const listing = allListings[i]; %>
    <div
      class="card listing-card col"
      onclick="window.location.href='/listings/<%= listing._id %>'"
    >
      <img
        src="<%= listing.image.url.replace('/upload/', '/upload/w_600,q_auto,f_auto/') %>"
        class="card-img-top"
        alt="<%= listing.image.filename %>"
        loading="<%= i === 0 ? 'eager' : 'lazy' %>"
        width="300"
        height="200"
      />

      <!-- Wishlist Heart Icon -->
      <% if (typeof currUser !== 'undefined' && currUser && currUser.role === 'user') { %>
      <button
        class="wishlist-btn <%= userWishlist.includes(listing._id.toString()) ? 'active' : '' %>"
        data-listing-id="<%= listing._id %>"
        onclick="event.stopPropagation(); toggleWishlist('<%= listing._id %>', this);"
        title="Add to Wishlist"
      >
        <i class="bi bi-heart-fill"></i>
      </button>
      <% } else if (!currUser) { %>
      <button
        class="wishlist-btn"
        data-listing-id="<%= listing._id %>"
        onclick="event.stopPropagation(); redirectToSignup();"
        title="Sign up to save favorites"
      >
        <i class="bi bi-heart-fill"></i>
      </button>
      <% } %>

      <div class="card-img-overlay"></div>
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <p class="card-text mt-1 mb-1">
            <b><%= listing.title %></b>
          </p>
          <p class="card-text mt-1 mb-1 me-3 small text-muted">
            <i class="bi bi-star-fill text-warning"></i>
            <%= listing.avgRating?.toFixed(1) || "N/A" %>
          </p>
        </div>
        <div class="d-flex align-items-center justify-content-between">
          <p
            class="card-text listing-price mt-1 mb-0"
            data-original-price="<%= listing.price %>"
          >
            &#8377;<%= listing.price.toLocaleString("en-IN") %>/night.
          </p>
          <div class="card-text mb-0">
            <% if (!currUser) { %>
            <a
              href="/signup"
              class="btn btn-color btn-sm rounded-pill px-3 py-1 book-now-btn"
              onclick="event.stopPropagation();"
              >Book Now</a
            >
            <% } else if (currUser.role === 'user' || currUser.role === 'admin')
            { %>
            <a
              href="/listings/<%= listing._id %>/bookings/new"
              class="btn btn-color btn-sm rounded-pill px-3 py-1 book-now-btn"
              onclick="event.stopPropagation();"
            >
              Book Now
            </a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% } %>
    <% } %>
  </div>
</body>

<script src="/js/wishlist.js"></script>
<script src="/js/search.js"></script>
